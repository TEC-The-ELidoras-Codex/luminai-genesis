name: Sync Substack to WordPress

on:
  # webhook trigger for instant dispatch
  repository_dispatch:
    types: [new_substack_post]
  # scheduled fallback (every 6 hours)
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  sync-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get LuminAI Codex Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.LUMINAI_APP_ID }}
          private-key: ${{ secrets.LUMINAI_PRIVATE_KEY }}
          repositories: ${{ github.repository }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install feedparser requests python-wordpress-xmlrpc

      - name: Fetch Substack RSS and publish to WordPress
        env:
          WP_URL: ${{ secrets.WP_URL }}
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_PASSWORD: ${{ secrets.WP_PASSWORD }}
          SUBSTACK_RSS: ${{ secrets.SUBSTACK_RSS_URL }}
        run: |
          python scripts/sync_substack_to_wp.py

      # Fallback: If SSH secrets are present, upload HTML to server and create posts using WP-CLI
      - name: Upload generated posts to server via SCP (optional SSH fallback)
        if: ${{ secrets.WP_SSH_HOST != '' && secrets.WP_SSH_PRIVATE_KEY != '' }}
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.WP_SSH_HOST }}
          username: ${{ secrets.WP_SSH_USER }}
          key: ${{ secrets.WP_SSH_PRIVATE_KEY }}
          port: ${{ secrets.WP_SSH_PORT || 22 }}
          source: "dist/substack/*.html"
          target: "/tmp/luminai_posts/"

      - name: Create posts via WP-CLI on server (optional SSH fallback)
        if: ${{ secrets.WP_SSH_HOST != '' && secrets.WP_SSH_PRIVATE_KEY != '' }}
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.WP_SSH_HOST }}
          username: ${{ secrets.WP_SSH_USER }}
          key: ${{ secrets.WP_SSH_PRIVATE_KEY }}
          port: ${{ secrets.WP_SSH_PORT || 22 }}
          script: |
            set -e
            mkdir -p /tmp/luminai_posts || true
            WP_CLI_PATH=${{ secrets.WP_CLI_PATH || 'wp' }}
            for f in /tmp/luminai_posts/*.html; do
              [ -f "$f" ] || continue
              title=$(basename "$f" .html)
              # If WP path is provided, use it; otherwise rely on wp in PATH
              if [ -n "${{ secrets.WP_CLI_PATH }}" ]; then
                ${WP_CLI_PATH} post create "$f" --post_status=publish --post_title="$title" --porcelain || true
              else
                wp post create "$f" --post_status=publish --post_title="$title" --porcelain || true
              fi
            done

      - name: Commit tracking file as LuminAI Codex
        if: success()
        run: |
          git config --local user.email "luminai-codex[bot]@users.noreply.github.com"
          git config --local user.name "luminai-codex[bot]"
          git remote set-url origin https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${{ github.repository }}
          git add .published_posts.txt || true
          git commit -m "chore: LuminAI Codex tracked new WordPress post" || true
          git push || true
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Notify Discord on success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "✅ WordPress synced from Substack"
          description: "Latest Substack posts are now on WordPress"
          color: 0x00ff00

      - name: Notify Discord on failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "❌ WordPress sync failed"
          description: "Check logs for details"
          color: 0xff0000
