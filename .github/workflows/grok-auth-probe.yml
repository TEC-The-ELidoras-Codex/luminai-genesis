name: grok-auth-probe
on:
  workflow_dispatch:

jobs:
  auth-probe:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requests
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run authenticated XAI probe
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY || secrets.XAI_API_KEY }}
        run: |
          set -euo pipefail
          python3 - << 'PY'
import os, json
import requests
os.makedirs('diagnostics', exist_ok=True)
key = os.environ.get('GROK_API_KEY') or os.environ.get('XAI_API_KEY')
headers = {'Content-Type':'application/json'}
if key:
    headers['Authorization'] = f'Bearer {key}'
payload = {"model":"grok-2","messages":[{"role":"user","content":"Hello"}],"max_tokens":20}
try:
    r = requests.post('https://api.x.ai/v1/chat/completions', json=payload, headers=headers, timeout=20)
    out = {'status_code': r.status_code, 'text': r.text[:8000]}
except Exception as e:
    out = {'error': str(e)}
with open('diagnostics/xai-auth-probe.json', 'w') as f:
    json.dump(out, f, indent=2)
print(json.dumps(out))
PY

      - name: Upload probe artifact
        uses: actions/upload-artifact@v4
        with:
          name: xai-auth-probe
          path: diagnostics/xai-auth-probe.json
