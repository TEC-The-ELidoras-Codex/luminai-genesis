name: Repo Hygiene

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  hygiene:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ripgrep
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ripgrep

      - name: Run sanitizer
        run: |
          python3 scripts/sanitize_bundles.py

      - name: Verify no markers in canonical files (excluding backups)
        run: |
          rg -n --glob '!**/*.bak.*' 'You said:|Monday said:|Uploaded image|Generated by Copilot|\\\\wsl\\.localhost' docs/canonical && exit 1 || echo "No conversational markers found."

      - name: Run secrets scan
        run: |
          bash scripts/scan_secrets.sh docs/canonical

      - name: Fail on secrets
        run: |
          # If scan printed known key patterns, fail (crude gate). You can refine this later.
          ! rg -n -P 'AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}|ghp_[0-9A-Za-z]{36}|github_pat_[0-9A-Za-z_]{80,}|xox[baprs]-[0-9A-Za-z-]{10,48}|BEGIN (RSA|OPENSSH|EC) PRIVATE KEY|AIza[0-9A-Za-z_-]{35}|sk-[A-Za-z0-9]{20,}' docs/canonical
