name: "Generate PDFs for canonical docs"

permissions:
  contents: write

on:
  push:
    paths:
      - "docs/canonical/tec-chapter-one*.md"
      - "scripts/convert_markdown_to_pdf.py"

jobs:
  generate-pdfs:
    runs-on: ubuntu-latest
    name: Generate PDFs and commit
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install system dependencies for WeasyPrint
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-dev python3-pip python3-venv libcairo2 libpango-1.0-0 libgdk-pixbuf2.0-0 libffi-dev libxml2-dev libxslt1-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install weasyprint markdown

      - name: Convert TEC chapter markdown to PDF
        run: |
          set -e
          # Only convert TEC chapter markdown files to PDF to avoid creating unnecessary PDFs.
          for md in docs/canonical/tec-chapter-one*.md; do
            if [ -f "$md" ]; then
              python scripts/convert_markdown_to_pdf.py "$md"
            fi
          done

      - name: Commit and push generated PDFs (if any changes)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Only add PDFs matching the TEC chapter pattern to avoid committing other generated files
          git add docs/canonical/tec-chapter-one*.pdf || true
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "docs(ci): auto-generate TEC chapter PDF(s)" || true
            git push origin HEAD:$(git rev-parse --abbrev-ref HEAD)
          else
            echo "No PDF changes detected"
          fi
