name: Structural Conscience Check

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  integrity-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff black pylint yamllint

      - name: Lint with Ruff
        run: ruff check src/ --select=E,W,F

      - name: Format check with Black
        run: black --check src/

      - name: Type check with Pylint
        run: pylint src/ --fail-under=8.0 || true

      - name: Validate YAML
        run: yamllint -c '{extends: relaxed}' .github/ data/ || true

      - name: Validate JSON schemas
        run: |
          python -m json.tool data/codex/classes.json > /dev/null
          python -m json.tool data/codex/abilities.json > /dev/null
          python -m json.tool data/enounters/prologue_bar_fight.json > /dev/null

      - name: Verify commit message compliance
        if: github.event_name == 'pull_request'
        run: |
          # Check for TGCR principles in PR title
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore)(\(.+\))?:\ .+ ]]; then
            echo "⚠️  PR title should follow conventional commits: type(scope): description"
            exit 0
          fi

  structural-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate project structure
        run: |
          required_dirs=(
            "src/astradigital"
            "data/codex"
            "docs"
            "scripts"
            ".vscode"
          )
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "Missing required directory: $dir"
              exit 1
            fi
          done
          echo "✓ Project structure validated"

      - name: Check documentation completeness
        run: |
          required_docs=(
            "README.md"
            "CONTRIBUTING.md"
            "docs/STRUCTURAL_CONSCIENCE.md"
          )
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "Missing required documentation: $doc"
              exit 1
            fi
          done
          echo "✓ Documentation complete"
