name: Create repository webhook

on:
  workflow_dispatch:

jobs:
  create-webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Preflight secrets
        env:
          GITHUB_TOKEN_PAT: ${{ secrets.GITHUB_MANAGEMENT_PAT }}
          TARGET_URL: ${{ secrets.WEBHOOK_TARGET_URL }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          set -euo pipefail
          missing=0
          if [ -z "${GITHUB_TOKEN_PAT:-}" ]; then echo "::warning::Missing GITHUB_MANAGEMENT_PAT secret — skipping webhook creation"; missing=1; fi
          if [ -z "${TARGET_URL:-}" ]; then echo "::warning::Missing WEBHOOK_TARGET_URL secret — skipping webhook creation"; missing=1; fi
          if [ -z "${WEBHOOK_SECRET:-}" ]; then echo "::warning::Missing WEBHOOK_SECRET secret — skipping webhook creation"; missing=1; fi
          if [ "$missing" -eq 1 ]; then
            echo "Secrets not present; exiting without creating webhook."
            exit 0
          fi

      - name: Ensure jq is available
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Create webhook via REST API
        env:
          GITHUB_TOKEN_PAT: ${{ secrets.GITHUB_MANAGEMENT_PAT }}
          TARGET_URL: ${{ secrets.WEBHOOK_TARGET_URL }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          REPO_FULL: ${{ github.repository }}
        run: |
          set -euo pipefail
          if [ -z "${GITHUB_TOKEN_PAT:-}" ]; then echo "Missing GITHUB_MANAGEMENT_PAT secret"; exit 1; fi
          if [ -z "${TARGET_URL:-}" ]; then echo "Missing WEBHOOK_TARGET_URL secret"; exit 1; fi
          OWNER=$(echo "$REPO_FULL" | cut -d'/' -f1)
          REPO=$(echo "$REPO_FULL" | cut -d'/' -f2)
          payload=$(jq -n --arg url "$TARGET_URL" --arg secret "$WEBHOOK_SECRET" '{name:"web",active:true,events:["push","pull_request"],config:{url:$url,content_type:"json",secret:$secret,insecure_ssl:"0"}}')
          echo "Creating webhook for $OWNER/$REPO -> $TARGET_URL"
          resp=$(curl -sS -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_TOKEN_PAT" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/$OWNER/$REPO/hooks -d "$payload")
          echo "$resp" | jq .

      - name: Trigger import labels workflow (optional)
        env:
          GITHUB_TOKEN_PAT: ${{ secrets.GITHUB_MANAGEMENT_PAT }}
          REPO_FULL: ${{ github.repository }}
        run: |
          # Optionally trigger the import-labels workflow using the Dispatch API
          if [ -z "${GITHUB_TOKEN_PAT:-}" ]; then
            echo "::warning::GITHUB_MANAGEMENT_PAT not configured, skipping workflow trigger"
            exit 0
          fi
          OWNER=$(echo "$REPO_FULL" | cut -d'/' -f1)
          REPO=$(echo "$REPO_FULL" | cut -d'/' -f2)
          echo "Triggering import-labels workflow_dispatch (if present)"
          curl -sS -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $GITHUB_TOKEN_PAT" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/$OWNER/$REPO/actions/workflows/import-labels.yml/dispatches -d '{"ref":"'"${GITHUB_REF_NAME:-main}"'"}' || true
