name: capture-xai-probe-now
on:
  workflow_dispatch:

jobs:
  capture-probe:
    runs-on: ubuntu-latest
    steps:
      - name: Run authenticated XAI probe (curl)
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p diagnostics
          python3 - << 'PY'
import os, json, time
k = bool(os.environ.get('XAI_API_KEY'))
with open('diagnostics/probe-meta.json','w') as f:
    json.dump({'xai_api_key_present': k, 'ts': time.time()}, f)
print('XAI_API_KEY present:', k)
PY
          cat > /tmp/payload.json <<'PAY'
{"model":"grok-2","messages":[{"role":"user","content":"Automated capture probe: are you online?"}],"max_tokens":120}
PAY
          # Attempt POST and always write output (even if error)
          curl -sS -H "Authorization: Bearer ${XAI_API_KEY}" -H "Content-Type: application/json" -d @/tmp/payload.json https://api.x.ai/v1/chat/completions -o diagnostics/xai-auth-probe.json -w "\n%{http_code}\n" || true

      - name: Upload probe artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xai-probe-capture
          path: diagnostics/
